# override to push to a different registry or tag the image differently
REGISTRY ?= ghcr.io/zhaohuabing
TAG ?= v0.0.1

# Make sure we pick up any localq overrides.
-include .makerc

build: cve-agent
cve-agent:
	go build -o cve-agent github.com/zhaohuabing/cve-agent/cmd/cve-agent
	chmod +x cve-agent

run: cve-agent
	./cve-agent --kube-config ~/.kube/config

build-static: docker/cve-agent-static

docker/cve-agent-static:
	CGO_ENABLED=0 GOOS=linux go build \
		-a --ldflags '-extldflags "-static"' -tags netgo -installsuffix netgo \
		-o docker/cve-agent-static github.com/zhaohuabing/cve-agent/cmd/cve-agent
	chmod +x docker/cve-agent-static

docker-build: docker/cve-agent-static
	docker build -t $(REGISTRY)/cve-agent:$(TAG) docker/

docker-push: docker-build
	docker push $(REGISTRY)/cve-agent:$(TAG)

clean:
	rm -f cve-agent
	rm -f docker/cve-agent-static
